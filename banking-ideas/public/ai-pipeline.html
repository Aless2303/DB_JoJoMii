<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BANK//IDEAS - AI Pipeline Workflow</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            overflow: hidden;
            height: 100vh;
        }

        /* ===== HEADER ===== */
        .header {
            height: 56px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            position: relative;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 16px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #58a6ff, #a371f7);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .logo span {
            color: #a371f7;
        }

        .divider {
            width: 1px;
            height: 24px;
            background: #30363d;
        }

        .workflow-name {
            font-size: 14px;
            color: #8b949e;
        }

        .header-center {
            display: flex;
            gap: 8px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .pill {
            background: #21262d;
            border: 1px solid #30363d;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #8b949e;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pill-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .pill-dot.green {
            background: #3fb950;
        }

        .pill-dot.blue {
            background: #58a6ff;
        }

        .pill-dot.purple {
            background: #a371f7;
        }

        .header-right {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
            border: none;
        }

        .btn-ghost {
            background: transparent;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        .btn-ghost:hover {
            background: #21262d;
            border-color: #8b949e;
        }

        .btn-primary {
            background: #238636;
            color: #fff;
        }

        .btn-primary:hover {
            background: #2ea043;
        }

        .btn-primary.running {
            background: #9e6a03;
        }

        /* ===== MAIN LAYOUT ===== */
        .main {
            display: flex;
            height: calc(100vh - 56px);
        }

        /* ===== CANVAS AREA ===== */
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background:
                radial-gradient(circle at center, #161b22 0%, #0d1117 100%),
                repeating-linear-gradient(#21262d 0 1px, transparent 1px 100%),
                repeating-linear-gradient(90deg, #21262d 0 1px, transparent 1px 100%);
            background-size: 100% 100%, 20px 20px, 20px 20px;
        }

        .canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* SVG for connections */
        .connections-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* ===== ANIMATED DASHED CONNECTION PATHS ===== */
        .connection-path {
            fill: none;
            stroke: #30363d;
            stroke-width: 2;
            stroke-dasharray: 8 6;
            animation: flowDash 1s linear infinite;
        }

        @keyframes flowDash {
            0% {
                stroke-dashoffset: 28;
            }

            100% {
                stroke-dashoffset: 0;
            }
        }

        .connection-path.active {
            stroke: #f0883e;
            stroke-width: 3;
            stroke-dasharray: 12 8;
            filter: drop-shadow(0 0 8px rgba(240, 136, 62, 0.7));
            animation: flowDashActive 0.4s linear infinite;
        }

        @keyframes flowDashActive {
            0% {
                stroke-dashoffset: 40;
            }

            100% {
                stroke-dashoffset: 0;
            }
        }

        .connection-path.completed {
            stroke: #3fb950;
            stroke-width: 2;
            stroke-dasharray: 8 6;
            filter: drop-shadow(0 0 4px rgba(63, 185, 80, 0.5));
            animation: flowDashCompleted 0.8s linear infinite;
        }

        @keyframes flowDashCompleted {
            0% {
                stroke-dashoffset: 28;
            }

            100% {
                stroke-dashoffset: 0;
            }
        }

        /* Animated flow dots - particles moving along paths */
        .flow-dot {
            fill: #58a6ff;
            filter: drop-shadow(0 0 6px rgba(88, 166, 255, 0.9));
        }

        .flow-dot.active {
            fill: #f0883e;
            filter: drop-shadow(0 0 8px rgba(240, 136, 62, 0.9));
        }

        .flow-dot.completed {
            fill: #3fb950;
            filter: drop-shadow(0 0 6px rgba(63, 185, 80, 0.9));
        }

        /* ===== NODES CONTAINER ===== */
        .nodes-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        /* ===== NODE ===== */
        .node {
            position: absolute;
            width: 240px;
            background: #161b22;
            border: 2px solid #30363d;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .node:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(88, 166, 255, 0.2);
        }

        .node.selected {
            border-color: #a371f7;
            box-shadow: 0 0 0 3px rgba(163, 113, 247, 0.3), 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .node.running {
            border-color: #f0883e;
            animation: nodeGlow 1.5s ease-in-out infinite;
        }

        .node.completed {
            border-color: #3fb950;
        }

        .node.completed .node-status-indicator {
            background: #3fb950;
        }

        @keyframes nodeGlow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(240, 136, 62, 0.4), 0 4px 12px rgba(0, 0, 0, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(240, 136, 62, 0), 0 4px 12px rgba(0, 0, 0, 0.4);
            }
        }

        /* Node Header */
        .node-header {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #21262d;
            position: relative;
        }

        .node-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .node-icon.input {
            background: linear-gradient(135deg, #388bfd, #1f6feb);
        }

        .node-icon.validator {
            background: linear-gradient(135deg, #3fb950, #238636);
        }

        .node-icon.analyzer {
            background: linear-gradient(135deg, #a371f7, #8957e5);
        }

        .node-icon.aggregator {
            background: linear-gradient(135deg, #f0883e, #d29922);
        }

        .node-icon.builder {
            background: linear-gradient(135deg, #f778ba, #db61a2);
        }

        .node-icon.stats {
            background: linear-gradient(135deg, #79c0ff, #58a6ff);
        }

        .node-icon.visual {
            background: linear-gradient(135deg, #7ee787, #56d364);
        }

        .node-icon.output {
            background: linear-gradient(135deg, #a371f7, #8957e5);
        }

        .node-info {
            flex: 1;
            min-width: 0;
        }

        .node-title {
            font-size: 14px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .node-subtitle {
            font-size: 12px;
            color: #8b949e;
        }

        .node-status-indicator {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: #3fb950;
            border-radius: 50%;
            border: 3px solid #161b22;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #fff;
        }

        .node.completed .node-status-indicator {
            display: flex;
        }

        /* Node Body */
        .node-body {
            padding: 10px 14px;
        }

        .node-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .tag-llm {
            background: rgba(163, 113, 247, 0.15);
            color: #a371f7;
            border: 1px solid rgba(163, 113, 247, 0.3);
        }

        .tag-function {
            background: rgba(63, 185, 80, 0.15);
            color: #3fb950;
            border: 1px solid rgba(63, 185, 80, 0.3);
        }

        .tag-parallel {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            border: 1px solid rgba(88, 166, 255, 0.3);
        }

        .tag-sequential {
            background: rgba(240, 136, 62, 0.15);
            color: #f0883e;
            border: 1px solid rgba(240, 136, 62, 0.3);
        }

        /* Connection Points */
        .connection-point {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #30363d;
            border: 2px solid #484f58;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            transition: all 0.15s;
        }

        .connection-point.left {
            left: -7px;
        }

        .connection-point.right {
            right: -7px;
        }

        .node:hover .connection-point,
        .node.selected .connection-point {
            background: #58a6ff;
            border-color: #58a6ff;
            box-shadow: 0 0 8px rgba(88, 166, 255, 0.5);
        }

        .node.completed .connection-point {
            background: #3fb950;
            border-color: #3fb950;
        }

        /* Parallel Group */
        .parallel-group {
            position: absolute;
            background: rgba(163, 113, 247, 0.05);
            border: 2px dashed rgba(163, 113, 247, 0.3);
            border-radius: 16px;
            padding: 50px 20px 20px 20px;
        }

        .parallel-label {
            position: absolute;
            top: 12px;
            left: 20px;
            font-size: 11px;
            font-weight: 600;
            color: #a371f7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .parallel-label::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #a371f7;
            border-radius: 2px;
        }

        /* ===== SIDE PANEL ===== */
        .panel {
            width: 380px;
            background: #161b22;
            border-left: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.25s ease;
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            z-index: 50;
        }

        .panel.open {
            transform: translateX(0);
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0d1117;
        }

        .panel-title-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: linear-gradient(135deg, #a371f7, #8957e5);
        }

        .panel-title {
            font-size: 15px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .panel-close {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: #21262d;
            color: #f0f6fc;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .panel-close:hover {
            background: #f85149;
            border-color: #f85149;
            color: #fff;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-section {
            margin-bottom: 24px;
        }

        .panel-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #8b949e;
            margin-bottom: 10px;
        }

        .panel-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
        }

        .panel-card p {
            font-size: 13px;
            line-height: 1.6;
            color: #c9d1d9;
        }

        .code-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px;
            overflow-x: auto;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: #79c0ff;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .detail-item {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
        }

        .detail-label {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 14px;
            font-weight: 500;
            color: #f0f6fc;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 16px 24px;
            min-width: 400px;
            display: none;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        .progress-bar.visible {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-size: 13px;
            font-weight: 600;
            color: #f0f6fc;
        }

        .progress-status {
            font-size: 12px;
            color: #8b949e;
        }

        .progress-track {
            height: 4px;
            background: #21262d;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #a371f7, #3fb950);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 2px;
        }

        /* ===== ZOOM CONTROLS ===== */
        .zoom-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 10;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .zoom-btn:hover {
            background: #21262d;
            border-color: #8b949e;
        }

        /* ===== FLOW LEGEND ===== */
        .flow-legend {
            position: absolute;
            bottom: 24px;
            left: 24px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px 16px;
            z-index: 10;
        }

        .legend-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #8b949e;
            margin-bottom: 8px;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #c9d1d9;
        }

        .legend-line {
            width: 30px;
            height: 2px;
            border-radius: 1px;
        }

        .legend-line.idle {
            background: repeating-linear-gradient(90deg,
                    #30363d 0px,
                    #30363d 8px,
                    transparent 8px,
                    transparent 14px);
        }

        .legend-line.active {
            background: repeating-linear-gradient(90deg,
                    #f0883e 0px,
                    #f0883e 12px,
                    transparent 12px,
                    transparent 20px);
            box-shadow: 0 0 6px rgba(240, 136, 62, 0.5);
        }

        .legend-line.completed {
            background: repeating-linear-gradient(90deg,
                    #3fb950 0px,
                    #3fb950 8px,
                    transparent 8px,
                    transparent 14px);
            box-shadow: 0 0 4px rgba(63, 185, 80, 0.5);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">üè¶</div>
                <span>BANK//</span>IDEAS
            </div>
            <div class="divider"></div>
            <div class="workflow-name">AI Pipeline Workflow</div>
        </div>

        <div class="header-center">
            <div class="pill">
                <span class="pill-dot green"></span>
                11 Agents
            </div>
            <div class="pill">
                <span class="pill-dot blue"></span>
                Vercel AI SDK
            </div>
            <div class="pill">
                <span class="pill-dot purple"></span>
                Claude 3 Haiku
            </div>
        </div>

        <div class="header-right">
            <button class="btn btn-ghost" onclick="resetPipeline()">
                ‚Üª Reset
            </button>
            <button class="btn btn-primary" id="runBtn" onclick="runPipeline()">
                ‚ñ∂ Run Pipeline
            </button>
        </div>
    </header>

    <!-- Main -->
    <div class="main">
        <div class="canvas-container" id="canvasContainer">
            <!-- SVG Connections -->
            <svg class="connections-svg" id="connectionsSvg">
                <defs>
                    <marker id="arrowhead" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto">
                        <path d="M0,0 L12,4 L0,8 L3,4 Z" fill="#30363d" />
                    </marker>
                    <marker id="arrowhead-active" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto">
                        <path d="M0,0 L12,4 L0,8 L3,4 Z" fill="#f0883e" />
                    </marker>
                    <marker id="arrowhead-completed" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto">
                        <path d="M0,0 L12,4 L0,8 L3,4 Z" fill="#3fb950" />
                    </marker>
                </defs>
            </svg>

            <!-- Nodes Container -->
            <div class="nodes-container" id="nodesContainer">
                <!-- Parallel Group -->
                <div class="parallel-group" id="parallelGroup">
                    <div class="parallel-label">Parallel Execution ‚Ä¢ Promise.all()</div>
                </div>

                <!-- Nodes will be created by JavaScript -->
            </div>

            <!-- Flow Legend -->
            <div class="flow-legend">
                <div class="legend-title">Flow Status</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-line idle"></div>
                        <span>Idle</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line active"></div>
                        <span>Processing</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line completed"></div>
                        <span>Completed</span>
                    </div>
                </div>
            </div>

            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
                <button class="zoom-btn" onclick="zoomReset()">‚äô</button>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="panel" id="panel">
            <div class="panel-header">
                <div class="panel-title-wrapper">
                    <div class="panel-icon" id="panelIcon">üìù</div>
                    <div class="panel-title" id="panelTitle">Agent Details</div>
                </div>
                <button class="panel-close" onclick="closePanel()" title="Close panel">‚úï</button>
            </div>
            <div class="panel-content" id="panelContent"></div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar" id="progressBar">
        <div class="progress-header">
            <div class="progress-title">üöÄ Running Pipeline</div>
            <div class="progress-status" id="progressStatus">Initializing...</div>
        </div>
        <div class="progress-track">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <script>
        // ===== NODE DEFINITIONS - UPDATED FROM REPOSITORY =====
        const nodes = [
            {
                id: 'input',
                title: 'Form Input',
                subtitle: '7-Step Form',
                icon: 'üìù',
                iconClass: 'input',
                tags: ['Zod', 'React Hook Form'],
                tagTypes: ['function', 'function'],
                x: 60,
                y: 280,
                description: 'A comprehensive 7-step form that collects all information about the banking innovation idea. Each step focuses on different aspects: basic info, technologies, business context, regulations, differentiators, and additional details.',
                schema: `const IdeaFormSchema = z.object({
  // Step 1: Basic Info
  title: z.string().min(3).max(60),
  shortDescription: z.string().min(10).max(280),
  category: z.enum(["payments", "lending", 
    "investments", "customer-experience", 
    "security", "open-banking", 
    "sustainability", "other"]),
  problemSolved: z.string().min(20),

  // Step 2: Technologies
  aiTechnologies: z.array(z.enum([...])),
  blockchainTechnologies: z.array(z.enum([...])),
  otherTechnologies: z.array(z.enum([...])),

  // Step 3-7: Business, Regulations, etc.
  ...
});`,
                details: [
                    { label: 'Steps', value: '7' },
                    { label: 'Fields', value: '20+' },
                    { label: 'Validation', value: 'Zod' },
                    { label: 'Storage', value: 'PostgreSQL' }
                ]
            },
            {
                id: 'validator',
                title: 'Validator Agent',
                subtitle: 'claude-3-haiku',
                icon: 'üîç',
                iconClass: 'validator',
                tags: ['LLM', 'Sequential'],
                tagTypes: ['llm', 'sequential'],
                x: 380,
                y: 280,
                description: 'Acts as a FRAUD DETECTOR at Deutsche Bank. Validates, normalizes, and enriches raw form data. Calculates credibility scores, checks banking relevance, detects satirical/fake submissions, and determines maximum possible scores. Never leaves fields empty.',
                schema: `const ValidatedIdeaSchema = z.object({
  ideaTitle: z.string(),
  bigIdea: z.string(),
  mainCategory: z.string(),
  coreTechnologies: z.array(z.string()),
  applicableRegulations: z.array(z.string()),
  projectStage: z.string(),
  // ... normalized fields ...
  
  // PRE-SCORING FIELDS
  credibilityScore: z.number().min(0).max(100),
  bankingRelevance: z.enum([
    "high", "medium", "low", "none"
  ]),
  consistencyIssues: z.array(z.string()),
  isSatiricalOrFake: z.boolean(),
  maxPossibleScore: z.number().min(0).max(100)
});`,
                details: [
                    { label: 'Model', value: 'claude-3-haiku' },
                    { label: 'Role', value: 'Fraud Detector' },
                    { label: 'Method', value: 'generateObject()' },
                    { label: 'Execution', value: 'Sequential' }
                ]
            },
            {
                id: 'basic',
                title: 'Basic Info Analyzer',
                subtitle: 'claude-3-haiku',
                icon: 'üìã',
                iconClass: 'analyzer',
                tags: ['LLM', 'Parallel'],
                tagTypes: ['llm', 'parallel'],
                x: 720,
                y: 60,
                isParallel: true,
                description: 'Acts as a TOP FINTECH COPYWRITER and PITCH EXPERT who has helped secure $500M+ in funding. Creates captivating headlines, punchy taglines, rewrites problems as urgent crises, generates quantifiable benefits, and identifies exact target audience.',
                schema: `const BasicInfoAnalysisSchema = z.object({
  headline: z.string()
    .describe("Captivating headline for the idea"),
  tagline: z.string()
    .describe("Short marketing slogan"),
  category: z.string()
    .describe("Simplified category (1-2 words)"),
  problemSummary: z.string()
    .describe("Problem as an urgent crisis"),
  keyBenefits: z.array(z.string())
    .describe("5 concrete, quantifiable benefits"),
  targetAudience: z.string()
    .describe("Exact description of users & buyers")
});`,
                details: [
                    { label: 'Model', value: 'claude-3-haiku' },
                    { label: 'Role', value: 'Pitch Expert' },
                    { label: 'Method', value: 'generateObject()' },
                    { label: 'Execution', value: 'Parallel' }
                ]
            },
            {
                id: 'tech',
                title: 'Tech Stack Analyzer',
                subtitle: 'claude-3-haiku',
                icon: '‚öôÔ∏è',
                iconClass: 'analyzer',
                tags: ['LLM', 'Parallel'],
                tagTypes: ['llm', 'parallel'],
                x: 720,
                y: 160,
                isParallel: true,
                description: 'Acts as a CHIEF TECHNOLOGY OFFICER of a major fintech with 20 years experience. Assesses technology stack, identifies cutting-edge tech, evaluates integration complexity, scalability potential, and technical risks.',
                schema: `const TechAnalysisSchema = z.object({
  techStack: z.array(z.string())
    .describe("Core technologies"),
  innovationLevel: z.enum([
    "revolutionary", "innovative", 
    "standard", "outdated"
  ]),
  integrationComplexity: z.enum([
    "low", "medium", "high", "extreme"
  ]),
  scalabilityScore: z.number().min(0).max(100),
  technicalRisks: z.array(z.string()),
  techSummary: z.string()
});`,
                details: [
                    { label: 'Model', value: 'claude-3-haiku' },
                    { label: 'Role', value: 'CTO Expert' },
                    { label: 'Method', value: 'generateObject()' },
                    { label: 'Execution', value: 'Parallel' }
                ]
            },
            {
                id: 'business',
                title: 'Business Analyzer',
                subtitle: 'claude-3-haiku',
                icon: 'üíº',
                iconClass: 'analyzer',
                tags: ['LLM', 'Parallel'],
                tagTypes: ['llm', 'parallel'],
                x: 720,
                y: 260,
                isParallel: true,
                description: 'Acts as a McKINSEY SENIOR PARTNER with 25 years in banking strategy. Analyzes market opportunity, competitive landscape, revenue potential, strategic alignment with Deutsche Bank goals, and implementation timeline.',
                schema: `const BusinessAnalysisSchema = z.object({
  marketOpportunity: z.enum([
    "massive", "large", "medium", "niche"
  ]),
  competitiveAdvantage: z.string(),
  revenueModel: z.string(),
  implementationCost: z.enum([
    "low", "medium", "high", "very-high"
  ]),
  strategicAlignment: z.number().min(0).max(100),
  businessSummary: z.string()
});`,
                details: [
                    { label: 'Model', value: 'claude-3-haiku' },
                    { label: 'Role', value: 'Strategy Partner' },
                    { label: 'Method', value: 'generateObject()' },
                    { label: 'Execution', value: 'Parallel' }
                ]
            },
            {
                id: 'regulations',
                title: 'Regulations Analyzer',
                subtitle: 'claude-3-haiku',
                icon: '‚öñÔ∏è',
                iconClass: 'analyzer',
                tags: ['LLM', 'Parallel'],
                tagTypes: ['llm', 'parallel'],
                x: 720,
                y: 360,
                isParallel: true,
                description: 'Acts as a HEAD OF COMPLIANCE at a European bank. Analyzes regulatory implications (PSD2, GDPR, MiFID II, etc.), identifies compliance risks, required certifications, and regulatory timeline.',
                schema: `const RegulationsAnalysisSchema = z.object({
  applicableRegulations: z.array(z.string()),
  complianceRisk: z.enum([
    "low", "medium", "high", "critical"
  ]),
  requiredCertifications: z.array(z.string()),
  regulatoryTimeline: z.string(),
  complianceSummary: z.string(),
  dataPrivacyImpact: z.enum([
    "minimal", "moderate", "significant"
  ])
});`,
                details: [
                    { label: 'Model', value: 'claude-3-haiku' },
                    { label: 'Role', value: 'Compliance Head' },
                    { label: 'Method', value: 'generateObject()' },
                    { label: 'Execution', value: 'Parallel' }
                ]
            },
            {
                id: 'differentiators',
                title: 'Differentiators Analyzer',
                subtitle: 'claude-3-haiku',
                icon: 'üéØ',
                iconClass: 'analyzer',
                tags: ['LLM', 'Parallel'],
                tagTypes: ['llm', 'parallel'],
                x: 720,
                y: 460,
                isParallel: true,
                description: 'Acts as a VENTURE CAPITALIST who has seen 10,000+ pitches. Identifies unique value propositions, competitive moats, innovation factors, and what makes this idea stand out from existing solutions.',
                schema: `const DifferentiatorsAnalysisSchema = z.object({
  uniqueValueProp: z.string(),
  competitiveMoat: z.enum([
    "strong", "moderate", "weak", "none"
  ]),
  innovationScore: z.number().min(0).max(100),
  marketDifferentiators: z.array(z.string()),
  patentPotential: z.boolean(),
  disruptionLevel: z.enum([
    "disruptive", "evolutionary", "incremental"
  ])
});`,
                details: [
                    { label: 'Model', value: 'claude-3-haiku' },
                    { label: 'Role', value: 'VC Expert' },
                    { label: 'Method', value: 'generateObject()' },
                    { label: 'Execution', value: 'Parallel' }
                ]
            },
            {
                id: 'other',
                title: 'Other Aspects Analyzer',
                subtitle: 'claude-3-haiku',
                icon: 'üîÆ',
                iconClass: 'analyzer',
                tags: ['LLM', 'Parallel'],
                tagTypes: ['llm', 'parallel'],
                x: 720,
                y: 560,
                isParallel: true,
                description: 'Acts as a FUTURIST and INNOVATION DIRECTOR. Analyzes future potential, sustainability impact, social benefits, potential partnerships, and long-term vision for the idea.',
                schema: `const OtherAspectsSchema = z.object({
  futurePotential: z.enum([
    "transformative", "high", "moderate", "limited"
  ]),
  sustainabilityImpact: z.enum([
    "positive", "neutral", "negative"
  ]),
  socialBenefits: z.array(z.string()),
  potentialPartners: z.array(z.string()),
  longTermVision: z.string(),
  additionalInsights: z.string()
});`,
                details: [
                    { label: 'Model', value: 'claude-3-haiku' },
                    { label: 'Role', value: 'Futurist' },
                    { label: 'Method', value: 'generateObject()' },
                    { label: 'Execution', value: 'Parallel' }
                ]
            },
            {
                id: 'aggregator',
                title: 'Analysis Aggregator',
                subtitle: 'Pure Function',
                icon: 'üîÑ',
                iconClass: 'aggregator',
                tags: ['Function', 'Sequential'],
                tagTypes: ['function', 'sequential'],
                x: 1040,
                y: 280,
                description: 'A pure TypeScript function (NO LLM) that combines all 6 analysis outputs into a unified structure. Merges, deduplicates, and organizes data for the next stages. Zero API cost.',
                code: `function aggregateAnalyses(
  validated: ValidatedIdea,
  basic: BasicInfoAnalysis,
  tech: TechAnalysis,
  business: BusinessAnalysis,
  regulations: RegulationsAnalysis,
  differentiators: DifferentiatorsAnalysis,
  other: OtherAspectsAnalysis
): AggregatedData {
  return {
    // Combine all analyses
    summary: {
      headline: basic.headline,
      tagline: basic.tagline,
      category: basic.category,
    },
    technical: { ...tech },
    business: { ...business },
    compliance: { ...regulations },
    competitive: { ...differentiators },
    future: { ...other },
    metadata: {
      processedAt: new Date().toISOString(),
      validatedBy: "claude-3-haiku",
    }
  };
}`,
                details: [
                    { label: 'Type', value: 'Pure Function' },
                    { label: 'LLM Cost', value: '$0' },
                    { label: 'Input', value: '7 Objects' },
                    { label: 'Output', value: 'AggregatedData' }
                ]
            },
            {
                id: 'htmlbuilder',
                title: 'HTML Builder',
                subtitle: 'Pure Function',
                icon: 'üèóÔ∏è',
                iconClass: 'builder',
                tags: ['Function', 'Sequential'],
                tagTypes: ['function', 'sequential'],
                x: 1360,
                y: 280,
                description: 'A pure TypeScript function (NO LLM) that creates structured HTML sections from the aggregated data. Prepares the content structure before visual styling is applied.',
                code: `function buildHtmlStructure(
  aggregated: AggregatedData
): HtmlSections {
  return {
    header: buildHeader(aggregated.summary),
    techSection: buildTechSection(aggregated.technical),
    businessSection: buildBusinessSection(aggregated.business),
    complianceSection: buildComplianceSection(aggregated.compliance),
    competitiveSection: buildCompetitiveSection(aggregated.competitive),
    futureSection: buildFutureSection(aggregated.future),
    footer: buildFooter(aggregated.metadata)
  };
}`,
                details: [
                    { label: 'Type', value: 'Pure Function' },
                    { label: 'LLM Cost', value: '$0' },
                    { label: 'Input', value: 'AggregatedData' },
                    { label: 'Output', value: 'HtmlSections' }
                ]
            },
            {
                id: 'statistician',
                title: 'Statistician Agent',
                subtitle: 'claude-3-haiku',
                icon: 'üìä',
                iconClass: 'stats',
                tags: ['LLM', 'Sequential'],
                tagTypes: ['llm', 'sequential'],
                x: 1680,
                y: 280,
                description: 'Acts as a SENIOR DATA SCIENTIST at Deutsche Bank. Calculates final scores based on all analyses, applies caps from Validator\'s maxPossibleScore, generates final recommendation, and creates score breakdowns.',
                schema: `const StatisticsOutputSchema = z.object({
  // Individual scores (capped by maxPossibleScore)
  innovationScore: z.number().min(0).max(100),
  technicalScore: z.number().min(0).max(100),
  businessScore: z.number().min(0).max(100),
  complianceScore: z.number().min(0).max(100),
  differentiationScore: z.number().min(0).max(100),
  
  // Final weighted score
  finalScore: z.number().min(0).max(100),
  
  // Final recommendation
  recommendation: z.enum([
    "highly-recommended", "recommended",
    "consider", "needs-work", "not-recommended"
  ]),
  
  // Score breakdown explanation
  scoreBreakdown: z.string(),
  
  // Key factors
  topStrengths: z.array(z.string()).length(3),
  topWeaknesses: z.array(z.string()).length(3)
});`,
                details: [
                    { label: 'Model', value: 'claude-3-haiku' },
                    { label: 'Role', value: 'Data Scientist' },
                    { label: 'Method', value: 'generateObject()' },
                    { label: 'Execution', value: 'Sequential' }
                ]
            },
            {
                id: 'visual',
                title: 'Visual Designer',
                subtitle: 'Pure Function',
                icon: 'üé®',
                iconClass: 'visual',
                tags: ['Function', 'Sequential'],
                tagTypes: ['function', 'sequential'],
                x: 2000,
                y: 280,
                description: 'A pure TypeScript function (NO LLM) that applies Teletext styling to the HTML structure. Creates the final retro-styled output with progress bars, color coding, and visual elements.',
                code: `function applyTeletextStyling(
  htmlSections: HtmlSections,
  statistics: StatisticsOutput,
  originalTitle: string
): FinalVisualOutput {
  
  // Utility functions
  const scoreColor = (score: number) => 
    score >= 70 ? "#00FF00" : 
    score >= 50 ? "#FFFF00" : "#FF6600";
  
  const makeProgressBar = (score: number) => {
    const filled = Math.round(score / 10);
    return "[" + "‚ñà".repeat(filled) + 
           "‚ñë".repeat(10-filled) + "] " + score + "%";
  };

  // Generate full HTML with teletext styling
  const html = \`<div style="font-family:'VT323',
    monospace;background:#0000AA;...">
    <!-- Full Teletext HTML -->
  </div>\`;
  
  return { pages, htmlOutput: html, cssVariables };
}`,
                details: [
                    { label: 'Type', value: 'Pure Function' },
                    { label: 'LLM Cost', value: '$0' },
                    { label: 'Output', value: 'Teletext HTML' },
                    { label: 'Style', value: 'VT323 / Blue BG' }
                ]
            },
            {
                id: 'output',
                title: 'Generated Page',
                subtitle: 'PostgreSQL',
                icon: 'üì∫',
                iconClass: 'output',
                tags: ['Storage', 'Final'],
                tagTypes: ['function', 'sequential'],
                x: 2320,
                y: 280,
                description: 'The final output - a complete Teletext-style HTML page stored in PostgreSQL (generatedHtml, aiScore, aiAnalysis, aiRecommendation fields) and displayed to the user with all analysis and scores.',
                schema: `// Database Schema (ideas table)
generatedPages: text("generated_pages"), // JSON
generatedHtml: text("generated_html"),   // Full HTML
aiScore: integer("ai_score"),            // 0-100
aiAnalysis: text("ai_analysis"),         // JSON
aiRecommendation: text("ai_recommendation"),
  // "highly-recommended" | "recommended" | 
  // "consider" | "needs-work" | "not-recommended"

// Pipeline Result Interface
interface PipelineResult {
  success: boolean;
  validatedData: ValidatedIdea;
  aggregatedAnalysis: AggregatedData;
  statistics: StatisticsOutput;
  visualOutput: {
    pages: TeletextPage[];
    htmlOutput: string;
    cssVariables: object;
  };
}`,
                details: [
                    { label: 'Storage', value: 'PostgreSQL' },
                    { label: 'Format', value: 'Teletext HTML' },
                    { label: 'Access', value: '/ideas/[id]' },
                    { label: 'Fields', value: '5 AI columns' }
                ]
            }
        ];

        // ===== CONNECTIONS =====
        const connections = [
            { from: 'input', to: 'validator' },
            { from: 'validator', to: 'basic' },
            { from: 'validator', to: 'tech' },
            { from: 'validator', to: 'business' },
            { from: 'validator', to: 'regulations' },
            { from: 'validator', to: 'differentiators' },
            { from: 'validator', to: 'other' },
            { from: 'basic', to: 'aggregator' },
            { from: 'tech', to: 'aggregator' },
            { from: 'business', to: 'aggregator' },
            { from: 'regulations', to: 'aggregator' },
            { from: 'differentiators', to: 'aggregator' },
            { from: 'other', to: 'aggregator' },
            { from: 'aggregator', to: 'htmlbuilder' },
            { from: 'htmlbuilder', to: 'statistician' },
            { from: 'statistician', to: 'visual' },
            { from: 'visual', to: 'output' }
        ];

        // ===== STATE =====
        let isRunning = false;
        let zoom = 1;
        let panX = 0;
        let panY = 0;
        let flowAnimations = []; // Store animation references

        // ===== INITIALIZE =====
        function init() {
            createNodes();
            drawConnections();
            setupPanning();
        }

        // ===== CREATE NODES =====
        function createNodes() {
            const container = document.getElementById('nodesContainer');
            const parallelGroup = document.getElementById('parallelGroup');

            // Position parallel group
            parallelGroup.style.left = '700px';
            parallelGroup.style.top = '30px';
            parallelGroup.style.width = '280px';
            parallelGroup.style.height = '650px';

            nodes.forEach(node => {
                const el = document.createElement('div');
                el.className = 'node';
                el.id = `node-${node.id}`;
                el.setAttribute('data-id', node.id);
                el.style.left = node.x + 'px';
                el.style.top = node.y + 'px';

                el.innerHTML = `
                    <div class="connection-point left"></div>
                    <div class="connection-point right"></div>
                    <div class="node-status-indicator">‚úì</div>
                    <div class="node-header">
                        <div class="node-icon ${node.iconClass}">${node.icon}</div>
                        <div class="node-info">
                            <div class="node-title">${node.title}</div>
                            <div class="node-subtitle">${node.subtitle}</div>
                        </div>
                    </div>
                    <div class="node-body">
                        <div class="node-tags">
                            ${node.tags.map((tag, i) => `<span class="tag tag-${node.tagTypes[i]}">${tag}</span>`).join('')}
                        </div>
                    </div>
                `;

                el.onclick = () => showPanel(node.id);
                container.appendChild(el);
            });
        }

        // ===== DRAW CONNECTIONS =====
        function drawConnections() {
            const svg = document.getElementById('connectionsSvg');

            // Clear existing paths (but keep defs)
            svg.querySelectorAll('path').forEach(p => p.remove());
            svg.querySelectorAll('circle.flow-dot').forEach(c => c.remove());

            connections.forEach((conn, idx) => {
                const fromNode = document.getElementById(`node-${conn.from}`);
                const toNode = document.getElementById(`node-${conn.to}`);

                if (!fromNode || !toNode) return;

                const fromRect = fromNode.getBoundingClientRect();
                const toRect = toNode.getBoundingClientRect();
                const container = document.getElementById('canvasContainer').getBoundingClientRect();

                // Calculate connection points
                const fromX = fromRect.right - container.left - 7;
                const fromY = fromRect.top - container.top + fromRect.height / 2;
                const toX = toRect.left - container.left + 7;
                const toY = toRect.top - container.top + toRect.height / 2;

                // Create smooth bezier curve
                const midX = (fromX + toX) / 2;
                const controlOffset = Math.min(Math.abs(toX - fromX) * 0.5, 100);

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M ${fromX} ${fromY} C ${fromX + controlOffset} ${fromY}, ${toX - controlOffset} ${toY}, ${toX} ${toY}`;

                path.setAttribute('d', d);
                path.setAttribute('class', 'connection-path');
                path.setAttribute('data-from', conn.from);
                path.setAttribute('data-to', conn.to);
                path.setAttribute('marker-end', 'url(#arrowhead)');

                // Add unique ID for animation reference
                path.setAttribute('id', `path-${conn.from}-${conn.to}`);

                svg.appendChild(path);

                // Create animated flow dot for each path
                const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                dot.setAttribute('r', '4');
                dot.setAttribute('class', 'flow-dot');
                dot.setAttribute('data-path', `path-${conn.from}-${conn.to}`);

                // Create animation along path
                const animateMotion = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
                animateMotion.setAttribute('dur', '2s');
                animateMotion.setAttribute('repeatCount', 'indefinite');
                animateMotion.setAttribute('path', d);

                dot.appendChild(animateMotion);
                svg.appendChild(dot);
            });
        }

        // ===== SETUP PANNING =====
        function setupPanning() {
            const container = document.getElementById('canvasContainer');
            let isPanning = false;
            let startX, startY;

            // Set initial cursor to grab
            container.style.cursor = 'grab';

            container.addEventListener('mousedown', (e) => {
                // Allow panning from anywhere except nodes and panel
                if (!e.target.closest('.node') && !e.target.closest('.panel') &&
                    !e.target.closest('.zoom-controls') && !e.target.closest('.flow-legend')) {
                    isPanning = true;
                    startX = e.clientX - panX;
                    startY = e.clientY - panY;
                    container.style.cursor = 'grabbing';
                    e.preventDefault();
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (isPanning) {
                    panX = e.clientX - startX;
                    panY = e.clientY - startY;
                    updateTransform();
                }
            });

            document.addEventListener('mouseup', () => {
                if (isPanning) {
                    isPanning = false;
                    container.style.cursor = 'grab';
                }
            });

            // Mouse leave should also stop panning
            container.addEventListener('mouseleave', () => {
                if (isPanning) {
                    isPanning = false;
                    container.style.cursor = 'grab';
                }
            });

            // Add scroll wheel zoom
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                zoom = Math.max(0.3, Math.min(2.5, zoom + delta));
                updateTransform();
            }, { passive: false });
        }

        function updateTransform() {
            const nodesContainer = document.getElementById('nodesContainer');
            const svg = document.getElementById('connectionsSvg');
            nodesContainer.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
            svg.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
        }

        function zoomIn() {
            zoom = Math.min(zoom + 0.1, 2.5);
            updateTransform();
        }

        function zoomOut() {
            zoom = Math.max(zoom - 0.1, 0.3);
            updateTransform();
        }

        function zoomReset() {
            zoom = 1;
            panX = 0;
            panY = 0;
            updateTransform();
        }

        // ===== SHOW PANEL =====
        function showPanel(id) {
            const node = nodes.find(n => n.id === id);
            if (!node) return;

            // Update selection
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
            document.getElementById(`node-${id}`).classList.add('selected');

            // Update panel
            document.getElementById('panelIcon').textContent = node.icon;
            document.getElementById('panelTitle').textContent = node.title;

            let html = `
                <div class="panel-section">
                    <div class="panel-section-title">Description</div>
                    <div class="panel-card">
                        <p>${node.description}</p>
                    </div>
                </div>
            `;

            if (node.schema) {
                html += `
                    <div class="panel-section">
                        <div class="panel-section-title">Zod Schema</div>
                        <div class="code-block">${node.schema}</div>
                    </div>
                `;
            }

            if (node.code) {
                html += `
                    <div class="panel-section">
                        <div class="panel-section-title">Implementation</div>
                        <div class="code-block">${node.code}</div>
                    </div>
                `;
            }

            if (node.details) {
                html += `
                    <div class="panel-section">
                        <div class="panel-section-title">Details</div>
                        <div class="detail-grid">
                            ${node.details.map(d => `
                                <div class="detail-item">
                                    <div class="detail-label">${d.label}</div>
                                    <div class="detail-value">${d.value}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            document.getElementById('panelContent').innerHTML = html;
            document.getElementById('panel').classList.add('open');
        }

        function closePanel() {
            document.getElementById('panel').classList.remove('open');
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
        }

        // ===== RUN PIPELINE =====
        async function runPipeline() {
            if (isRunning) return;
            isRunning = true;

            const btn = document.getElementById('runBtn');
            const progress = document.getElementById('progressBar');
            const fill = document.getElementById('progressFill');
            const status = document.getElementById('progressStatus');

            resetPipeline();
            await sleep(100);

            btn.classList.add('running');
            btn.innerHTML = '‚è≥ Running...';
            progress.classList.add('visible');

            const steps = [
                { ids: ['input'], msg: 'Processing form input...', pct: 8 },
                { ids: ['validator'], msg: 'Validating & fraud detection...', pct: 18 },
                { ids: ['basic', 'tech', 'business', 'regulations', 'differentiators', 'other'], msg: 'Running 6 analyzers in parallel...', pct: 55, parallel: true },
                { ids: ['aggregator'], msg: 'Aggregating analyses...', pct: 65 },
                { ids: ['htmlbuilder'], msg: 'Building HTML structure...', pct: 75 },
                { ids: ['statistician'], msg: 'Calculating scores (with caps)...', pct: 85 },
                { ids: ['visual'], msg: 'Designing Teletext output...', pct: 95 },
                { ids: ['output'], msg: 'Complete!', pct: 100 }
            ];

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];

                status.textContent = step.msg;
                fill.style.width = step.pct + '%';

                // Set running state
                step.ids.forEach(id => {
                    document.getElementById(`node-${id}`).classList.add('running');
                    // Activate connections TO this node
                    document.querySelectorAll(`path[data-to="${id}"]`).forEach(p => {
                        p.classList.add('active');
                        p.setAttribute('marker-end', 'url(#arrowhead-active)');
                    });
                    // Activate flow dots for these paths
                    document.querySelectorAll(`circle[data-path*="-${id}"]`).forEach(dot => {
                        dot.classList.add('active');
                    });
                });

                await sleep(step.parallel ? 2000 : 800);

                // Set completed state
                step.ids.forEach(id => {
                    const node = document.getElementById(`node-${id}`);
                    node.classList.remove('running');
                    node.classList.add('completed');
                    // Complete connections TO this node
                    document.querySelectorAll(`path[data-to="${id}"]`).forEach(p => {
                        p.classList.remove('active');
                        p.classList.add('completed');
                        p.setAttribute('marker-end', 'url(#arrowhead-completed)');
                    });
                    // Complete flow dots
                    document.querySelectorAll(`circle[data-path*="-${id}"]`).forEach(dot => {
                        dot.classList.remove('active');
                        dot.classList.add('completed');
                    });
                });
            }

            status.textContent = '‚úÖ Pipeline completed!';
            btn.classList.remove('running');
            btn.innerHTML = '‚úì Complete';

            await sleep(3000);
            progress.classList.remove('visible');
            btn.innerHTML = '‚ñ∂ Run Pipeline';
            isRunning = false;
        }

        function resetPipeline() {
            if (isRunning) return;
            document.querySelectorAll('.node').forEach(n => {
                n.classList.remove('running', 'completed', 'selected');
            });
            document.querySelectorAll('.connection-path').forEach(p => {
                p.classList.remove('active', 'completed');
                p.setAttribute('marker-end', 'url(#arrowhead)');
            });
            document.querySelectorAll('.flow-dot').forEach(dot => {
                dot.classList.remove('active', 'completed');
            });
            document.getElementById('progressFill').style.width = '0%';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Close panel on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePanel();
            }
        });

        // Close panel when clicking on canvas (outside nodes)
        document.getElementById('canvasContainer').addEventListener('click', (e) => {
            if (e.target.id === 'canvasContainer' ||
                e.target.classList.contains('connections-svg') ||
                e.target.classList.contains('nodes-container')) {
                closePanel();
            }
        });

        // Initialize
        window.onload = init;
        window.onresize = drawConnections;
    </script>
</body>

</html>